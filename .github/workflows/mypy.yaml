on:
  workflow_call:
    inputs:
      TIMEOUT:
        type: number
        default: 30
        description: "Timeout for the job in minutes"
    secrets:
      DOCKER_USER:
        required: true
        description: "Docker registry username"
      DOCKER_OAT:
        required: true
        description: "Docker registry Organization Access Token"

env:
  SCRITICAL_HOMEDIR: /home/scriticaluser
  BASHRC: /home/scriticaluser/.bashrc_scritical

jobs:
  mypy:
    runs-on: ubuntu-24.04
    timeout-minutes: ${{ inputs.TIMEOUT }}
    env:
      DOCKER_TAG: u24-gcc-ompi-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set repo environment variables
        run: |
          repo_name="${{ github.event.repository.name }}"
          echo "REPO_NAME=$repo_name" >> "$GITHUB_ENV"
          echo "DOCKER_WORKING_DIR=${{ env.SCRITICAL_HOMEDIR }}/repos/$repo_name" >> "$GITHUB_ENV"
          echo "DOCKER_MOUNT_DIR=${{ env.SCRITICAL_HOMEDIR }}/mount/$repo_name" >> "$GITHUB_ENV"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_OAT }}

      - name: Start Docker container
        run: |
          docker run -t -d --name app \
            --mount "type=bind,src=${{ github.workspace }},target=${{ env.DOCKER_MOUNT_DIR }}" \
            scritical/private-dev:${{ env.DOCKER_TAG }} /bin/bash

          # Copy repo to working directory
          docker exec app /bin/bash -c "rm -rf $DOCKER_WORKING_DIR && mkdir -p $DOCKER_WORKING_DIR && cp -a $DOCKER_MOUNT_DIR/. $DOCKER_WORKING_DIR/"

      - name: MyPy type checking
        run: |
          docker exec \
            -e AGENT_NAME="${{ runner.name }}" \
            -e BUILD_REASON="${{ github.event_name }}" \
            app /bin/bash -c ". $BASHRC && cd $DOCKER_WORKING_DIR && mypy ."

      - name: Cleanup
        if: always()
        run: |
          # Stop and remove the container only if it exists to avoid noisy errors.
          if docker ps -a --format '{{.Names}}' | grep -qx app; then
            docker stop app && docker rm app || true
          fi
